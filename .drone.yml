---
kind: pipeline
name: pull_request

steps:
- name: install
  image: node
  environments:
    CYPRESS_CACHE_FOLDER: /root/.cache/Cypress
  commands:
  - npm ci

- name: commitlint
  image: node
  commands:
  - npx commitlint --from origin/master --to HEAD

- name: test
  image: node
  commands:
  - npm test

- name: web_server
  image: node
  detach: true
  commands:
  - npm start

- name: cypress
  image: node
  environments:
    CYPRESS_BASE_URL: http://web_server:3000
  commands:
  - npx wait-on http://web_server:3000
  - npx cypress run

trigger:
  event:
  - pull_request

---
kind: pipeline
name: release

steps:
- name: install
  image: node
  commands:
  - npm ci

- name: semantic_release
  image: node
  environment:
    GITHUB_TOKEN:
      from_secret: github_token
  commands:
    - npx semantic-release

trigger:
  branch:
  - master
  event:
  - push
